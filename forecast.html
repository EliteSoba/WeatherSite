<html>
<head>
	<meta charset="utf-8">
	<title>Test</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link href="css/forecast.css" rel="stylesheet">
</head>
<body>
	<h1>Forecast Search</h1>
	<script src="http://code.jquery.com/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="http://openlayers.org/api/OpenLayers.js"></script>
	<script src="js/jquery-1.11.3.js"></script>
	<div class="container">
		<form role="form">
		<div class="row">
			<div class="col-md-3">
				<label for="street">Street Address<span class="req">*</span></label>
				<input type="text" class="form-control" id="street" placeholder="Enter street address">
				<div id="streeterr" class="error">
				</div>
			</div>
			<div class="col-md-2">
				<label for="city">City<span class="req">*</span></label>
				<input type="text" class="form-control" id="city" placeholder="Enter the city name">
				<div id="cityerr" class="error">
				</div>
			</div>
			<div class="col-md-2">
				<label for="state">State<span class="req">*</span></label>
				<SELECT class="form-control" id="state">
					<OPTION SELECTED VALUE="">Select your state...</OPTION>
					<OPTION VALUE="AK">Alaska</OPTION>
					<OPTION VALUE="AL">Alabama</OPTION>
					<OPTION VALUE="AR">Arkansas</OPTION>
					<OPTION VALUE="AZ">Arizona</OPTION>
					<OPTION VALUE="CA">California</OPTION>
					<OPTION VALUE="CO">Colorado</OPTION>
					<OPTION VALUE="CT">Connecticut</OPTION>
					<OPTION VALUE="DE">Delaware</OPTION>
					<OPTION VALUE="DC">District of Columbia</OPTION>
					<OPTION VALUE="FL">Florida</OPTION>
					<OPTION VALUE="GA">Georgia</OPTION>
					<OPTION VALUE="HI">Hawaii</OPTION>
					<OPTION VALUE="ID">Idaho</OPTION>
					<OPTION VALUE="IL">Illinois</OPTION>
					<OPTION VALUE="IN">Indiana</OPTION>
					<OPTION VALUE="IA">Iowa</OPTION>
					<OPTION VALUE="KS">Kansas</OPTION>
					<OPTION VALUE="KY">Kentucky</OPTION>
					<OPTION VALUE="LA">Louisiana</OPTION>
					<OPTION VALUE="ME">Maine</OPTION>
					<OPTION VALUE="MD">Maryland</OPTION>
					<OPTION VALUE="MA">Massachusetts</OPTION>
					<OPTION VALUE="MI">Michigan</OPTION>
					<OPTION VALUE="MN">Minnesota</OPTION>
					<OPTION VALUE="MS">Mississippi</OPTION>
					<OPTION VALUE="MO">Missouri</OPTION>
					<OPTION VALUE="MT">Montana</OPTION>
					<OPTION VALUE="NE">Nebraska</OPTION>
					<OPTION VALUE="NV">Nevada</OPTION>
					<OPTION VALUE="NH">New Hampshire</OPTION>
					<OPTION VALUE="NJ">New Jersey</OPTION>
					<OPTION VALUE="NM">New Mexico</OPTION>
					<OPTION VALUE="NY">New York</OPTION>
					<OPTION VALUE="NC">North Carolina</OPTION>
					<OPTION VALUE="ND">North Dakota</OPTION>
					<OPTION VALUE="OH">Ohio</OPTION>
					<OPTION VALUE="OK">Oklahoma</OPTION>
					<OPTION VALUE="OR">Oregon</OPTION>
					<OPTION VALUE="PA">Pennsylvania</OPTION>
					<OPTION VALUE="RI">Rhode Island</OPTION>
					<OPTION VALUE="SC">South Carolina</OPTION>
					<OPTION VALUE="SD">South Dakota</OPTION>
					<OPTION VALUE="TN">Tennessee</OPTION>
					<OPTION VALUE="TX">Texas</OPTION>
					<OPTION VALUE="UT">Utah</OPTION>
					<OPTION VALUE="VT">Vermont</OPTION>
					<OPTION VALUE="VA">Virginia</OPTION>
					<OPTION VALUE="WA">Washington</OPTION>
					<OPTION VALUE="WV">West Virginia</OPTION>
					<OPTION VALUE="WI">Wisconsin</OPTION>
					<OPTION VALUE="WY">Wyoming</OPTION>
				</SELECT>
				<div id="stateerr" class="error">
				</div>
			</div>
			<div class="col-md-3">
				<label for="degree">Degree<span class="req">*</span></label><br />
				<label class="radio-inline"><INPUT TYPE="radio" NAME="degree" VALUE="us" CHECKED>Fahrenheit</label>
				<label class="radio-inline"><INPUT TYPE="radio" NAME="degree" VALUE="si">Celsius</label>
			</div>
			<div class="col-md-2" id="buttons">
				<button type="button" id="search" class="btn btn-primary btn-sm">
				<span class="glyphicon glyphicon-search" aria-hidden="true"></span> Search
				</button>
				<button type="reset" id="clear" class="btn btn-default btn-sm">
				<span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> Clear
				</button>
				<div id="forecast">
					Powered by: <img src="imag/forecast_logo.png" height=3.6%>
				</div>
			</div>
		</div>
		</form>
	<hr>
	<div id="responseArea">
		<!-- Nav tabs -->
		<ul class="nav nav-pills" role="tablist">
			<li role="presentation" class="active"><a href="#current" aria-controls="current" role="tab" data-toggle="tab">Right Now</a></li>
			<li role="presentation"><a href="#next" aria-controls="next" role="tab" data-toggle="tab">Next 24 Hours</a></li>
			<li role="presentation"><a href="#week" aria-controls="week" role="tab" data-toggle="tab">Next 7 Days</a></li>
		</ul>
		
		<!-- Tab panes -->
		<div class="tab-content">
			<div role="tabpanel" class="tab-pane fade in active" id="current">
				<div class="col-xs-12 col-md-6">
					<div class="col-xs-12">
						<table class="table table-striped">
							<tbody>
							<tr>
								<th colspan=2>
									<div class="col-xs-12 col-md-6" id="icon">
										<img src="imag/clear.png" height=50%>
									</div>
									<div class="col-xs-12 col-md-6">
										<div id="weather">
											Mostly Cloudy in Los Angeles, CA
										</div>
										<div class="col-xs-8 col-xs-offset-2" id="temp">
											<span id="templarge">71</span>&deg; F
										</div>
										<div class="col-xs-8 col-xs-offset-2" id="highlow">
											<span id="low">L: 70&deg;</span>
											|
											<span id="high">H: 79&deg;</span>
										</div>
										<div class="col-xs-2">
											<img src="imag/fb_icon.png" height=5%>
										</div>
									</div>
								</th>
							</tr>
							<tr>
								<td>Precipitation</td>
								<td>aaaa</td>
							</tr>
							<tr>
								<td>Chance of Rain</td>
								<td>bbbb</td>
							</tr>
							<tr>
								<td>Wind Speed</td>
								<td>cccc</td>
							</tr>
							<tr>
								<td>Dew Point</td>
								<td>dddd</td>
							</tr>
							<tr>
								<td>Humidity</td>
								<td>eeee</td>
							</tr>
							<tr>
								<td>Visibility</td>
								<td>ffff</td>
							</tr>
							<tr>
								<td>Sunrise</td>
								<td>gggg</td>
							</tr>
							<tr>
								<td>Sunset</td>
								<td>hhhh</td>
							</tr>
							</tbody>
						</table>
					</div>
				</div>
				<div class="col-xs-12 col-md-6">
					<div id="basicMap">
					</div>
				</div>
			</div>
			<div role="tabpanel" class="tab-pane fade" id="next">
				<div class="col-xs-12">
					Next 24 Hours Pane
				</div>
			</div>
			<div role="tabpanel" class="tab-pane fade" id="week">
				<div class="col-xs-12">
					Next 7 Days Pane
				</div>
			</div>
		</div>
	</div>
	</div>
	<script>
	$('#current a').click(function (e) {
		e.preventDefault()
		$(this).tab('show')
	});
	$('#next a').click(function (e) {
		e.preventDefault()
		$(this).tab('show')
	});
	$('#week a').click(function (e) {
		e.preventDefault()
		$(this).tab('show')
	});
	$("#street").focusout(function(){
		var street = $(this).val().trim();
		if (!street) {
			$("#streeterr").text("Please enter the street address");
		}
		else {
			$("#streeterr").text("");
		}
	});
	$("#city").focusout(function(){
		var city = $(this).val().trim();
		if (!city) {
			$("#cityerr").text("Please enter the city");
		}
		else {
			$("#cityerr").text("");
		}
	});
	$("#state").focusout(function(){
		var state = $(this).val().trim();
		if (!state) {
			$("#stateerr").text("Please select a state");
		}
		else {
			$("#stateerr").text("");
		}
	});
	var xhr = false;
	function getData(data) {
		if (window.XMLHttpRequest) {
			xhr = new XMLHttpRequest();
		}
		else {
			if (window.ActiveXObject) {
				try {
					xhr = new ActiveXObject("Microsoft.XMLHTTP");
				} catch (e) { } 
			}
		}
		if (xhr) {
			xhr.onreadystatechange = parseJson;
			xhr.open("GET", data, true);
			xhr.send(null);
		}
		else {
			$("#responseArea").text("An error occurred. Please try again.");
		}
	}
	function parseJson() {
		if (xhr.readyState == 4) {
			if (xhr.status == 200) {
				var outMsg = xhr.responseText;
				var data = jQuery.parseJSON(outMsg);
				console.log(data);
				console.log(data.latitude);
				var test = document.createElement('div');
				test.setAttribute("class", "row");
				test.innerHTML = outMsg;
				
				var lat = parseFloat(data.latitude);
				var lon = parseFloat(data.longitude);
				console.log(lat);
				console.log(lon);
				console.log(lat + lon);
				var lonlat = new OpenLayers.LonLat(lon, lat).transform(new OpenLayers.Projection("EPSG:4326"), 
								new OpenLayers.Projection("EPSG:900913"));;
				console.log(lonlat);
				var map = new OpenLayers.Map("basicMap");
				var mapnik = new OpenLayers.Layer.OSM();
				var layer_cloud = new OpenLayers.Layer.XYZ(
					"clouds",
					"http://${s}.tile.openweathermap.org/map/clouds/${z}/${x}/${y}.png",
					{
						isBaseLayer: false,
						opacity: 0.7,
						sphericalMercator: true
					}
				);

				var layer_precipitation = new OpenLayers.Layer.XYZ(
					"precipitation",
					"http://${s}.tile.openweathermap.org/map/precipitation/${z}/${x}/${y}.png",
					{
						isBaseLayer: false,
						opacity: 0.7,
						sphericalMercator: true
					}
				);
				map.addLayers([mapnik, layer_precipitation, layer_cloud]);
				map.setCenter(lonlat, 8);
				var ls = new OpenLayers.Control.LayerSwitcher({'ascending':false});
				map.addControl(ls);
				
				//$("#responseArea").append(test);
				$("#responseArea").css("visibility", "visible");
			}
			else {
				$("#responseArea").text("Error reading data");
			}
		}
	}
	$("#search").click(function(){
		var street = $("#street").val().trim();
		var city =  $("#city").val().trim();
		var state =  $("#state").val().trim();
		
		getData("https://api.forecast.io/forecast/5a86790b799489f59c2a56e57c06259d/47.1036507,-121.6174491?units=us&exclude=flags");
		if (street && city && state) {
			return true;
		}
		return false;
	});
	$("#clear").click(function(){
		$("#streeterr").text("");
		$("#cityerr").text("");
		$("#stateerr").text("");
		//DEBUG
		//$("#responseArea").text("");
		$("#responseArea").css("visibility", "hidden");
	});
	</script>
</body>
</html>